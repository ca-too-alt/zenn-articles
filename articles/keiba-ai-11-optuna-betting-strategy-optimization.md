---
title: "【馬券戦略編②】Optunaによる購入戦略の最適化：「儲かるルール」を自動探索する"
emoji: "🎯"
type: "tech"
topics: ["python", "機械学習", "Optuna", "ベイズ最適化", "数理最適化"]
published: false
---

# 【馬券戦略編②】Optunaによる購入戦略の最適化：「儲かるルール」を自動探索する

## はじめに：期待値1.0超えでも勝てない？

前回の記事で、Softmax関数を使って「勝率」と「期待値（EV）」を算出できるようになりました。
理論上は「期待値が1.0を超える馬券を買い続ければプラスになる」はずです。

しかし、現実はそう甘くありません。
例えば「勝率1%、オッズ150倍（期待値1.5）」の大穴馬券ばかり買っていたらどうなるでしょうか？
期待値は高いですが、的中するまでに資金が尽きて破産する可能性が高いです（ドローダウン）。

そこで必要になるのが、**「どの程度のリスク（確率）なら許容するか？」**というルールの設定です。
今回は、このルール作りをAI（Optuna）に任せて自動化するプロセスについて解説します。

## 1. 探索すべきパラメータ

「儲かるルール」を見つけるために、以下のパラメータを調整する必要があります。

1.  **期待値の閾値 (`ev_threshold`)**:
    - 「期待値がX以上なら買う」。高すぎると購入機会が減り、低すぎると損をするリスクが増えます。
2.  **確率の閾値 (`prob_threshold`)**:
    - 「勝率がY%以上なら買う」。これを設定することで、無謀な大穴狙いを防ぎ、的中率を安定させます。
3.  **購入点数上限 (`max_bets`)**:
    - 特に3連単などの複合馬券では、買い目が増えすぎると「トリガミ（当たっても損）」になりやすいため、点数を絞る必要があります。

これらを手作業で調整するのは不可能です。そこで登場するのが **Optuna** です。

## 2. Optuna：ベイズ最適化による高速探索

Optunaは、ハイパーパラメータ最適化のためのフレームワークです。
「グリッドサーチ（しらみつぶし）」が全ての組み合わせを試すのに対し、Optunaは**「過去の試行結果から、良さそうな領域を予測して重点的に探す（ベイズ最適化）」**ため、圧倒的に効率的です。

### 実装：最適化サービス (`optimization_service.py`)

実際のコードを見てみましょう。`src/keiba/services/analysis/application/optimization_service.py` に実装されています。

```python
def _objective_single(self, trial, bet_type, df, prob_col, target_col):
    """単勝・複勝の最適化を行う目的関数"""
    
    # 1. Optunaにパラメータの候補を出してもらう
    ev_threshold = trial.suggest_float('ev_threshold', 0.5, 3.0)
    prob_threshold = trial.suggest_float('prob_threshold', 0.01, 0.5)
    
    # 2. その条件でシミュレーション実行
    # (期待値 >= X) かつ (確率 >= Y) の馬券を抽出
    bet_targets = df[
        (df['expected_value'] >= ev_threshold) & 
        (df[prob_col] >= prob_threshold)
    ]
    
    # 3. 回収率（または利益）を計算して返す
    # Optunaはこの値を最大化しようとする
    if total_investment < 10000: # 試行回数が少なすぎる場合は除外
        return 0.0
        
    return total_return / total_investment
```

この関数を何百回も呼び出すことで、Optunaは徐々に「勝てる条件」へと収束していきます。

## 3. 評価指標：回収率だけでいいのか？

最初は「回収率」を最大化するように設定していましたが、問題が発生しました。
**「3000レース中、たった1回の大穴的中で回収率200%」**のような、極めて不安定な戦略が選ばれてしまったのです。

そこで、評価指標（目的関数）に**「シャープレシオ（Sharpe Ratio）」**の概念を取り入れました。

$$ シャープレシオ = \frac{平均リターン}{リターンの標準偏差（ブレ幅）} $$

単に利益が大きいだけでなく、**「毎レース安定して利益が出る」**戦略を高く評価するように変更しました。
これにより、「一発屋」の戦略が排除され、実運用に耐えうる堅実なルールが見つかるようになりました。

## 4. 最適化の結果

`notebooks/37_betting_strategy_analysis.ipynb` で最適化を実行した結果、以下のような「黄金のルール」が導き出されました。

**例：複勝（Place）の最適戦略**
- **EV閾値**: 1.5以上
- **確率閾値**: 70%以上
- **結果**: 的中率 47.4%、回収率 117.8%

**例：単勝（Win）の最適戦略**
- **EV閾値**: 1.2以上
- **確率閾値**: 15%以上
- **結果**: 的中率 18.5%、回収率 108.2%

AIは、人間では気づきにくい「オッズの歪み」を的確に見つけ出し、それをルール化してくれました。

## まとめ

- 期待値と確率の「足切りライン」を設けることで、リスクをコントロールする。
- Optunaを使うことで、膨大な組み合わせの中から「最適なルール」を自動探索できる。
- 回収率だけでなく、安定性（シャープレシオ）も考慮することが重要。

こうして、各券種ごとに「勝てる戦略」が完成しました。
しかし、1つの戦略に全財産を賭けるのは危険です。

次回は、これらの戦略を組み合わせ、リスクを分散しながら資産を増やす**「ポートフォリオ戦略」**について解説します。